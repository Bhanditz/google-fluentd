# Hello packaging friend!
#
# If you find yourself using this 'fpm --edit' feature frequently, it is
# a sign that fpm is missing a feature! I welcome your feature requests!
# Please visit the following URL and ask for a feature that helps you never
# need to edit this file again! :)
#   https://github.com/jordansissel/fpm/issues
# ------------------------------------------------------------------------

# Disable the stupid stuff rpm distros include in the build process by default:
<% %w(prep build install clean).each do |step| -%>
<%# These definitions have to be non-empty... I guess... -%>
#   Disable any <%= step %> shell actions. replace them with simply 'true'
%define __spec_<%= step %>_post true
%define __spec_<%= step %>_pre true
<% end -%>
# Disable checking for unpackaged files ?
#%undefine __check_files

# Use <%= attributes[:rpm_digest] %> file digest method
%define _binary_filedigest_algorithm <%= digest_algorithm %>

# Use <%= attributes[:rpm_compression] %> payload compression
%define _binary_payload <%= payload_compression %> 

<% (attributes[:rpm_filter_from_requires] or []).each do |reqfilter| -%>
%filter_from_requires <%= reqfilter %>
<% end -%>
<% (attributes[:rpm_filter_from_provides] or []).each do |provfilter| -%>
%filter_from_provides <%= provfilter %>
<% end -%>
<% if !(attributes[:rpm_filter_from_requires] or []).empty? or !(attributes[:rpm_filter_from_provides] or []).empty?-%>
%filter_setup
<% end -%>

Name: <%= name %>
Version: <%= version %>
<% if epoch -%>
Epoch: <%= epoch %>
<% end -%>
Release: <%= iteration or 1 %>
<%# use the first line of the description as the summary -%>
Summary: <%= description.split("\n").first.empty? ? "_" :  description.split("\n").first %>
BuildArch: <%= architecture %>
<% if !attributes[:rpm_autoreqprov?] -%>
AutoReqProv: no
<% else -%>
AutoReqProv: yes
<% end -%>
<% if attributes[:rpm_autoreq?] -%>
AutoReq: yes
<% end -%>
<% if attributes[:rpm_autoprov?] -%>
AutoProv: yes
<% end -%>
# Seems specifying BuildRoot is required on older rpmbuild (like on CentOS 5)
# fpm passes '--define buildroot ...' on the commandline, so just reuse that.
BuildRoot: %buildroot
# Add prefix, must not end with /
<% if !prefix.nil? and !prefix.empty? %>
Prefix: <%= prefix.gsub(/([^\/]+)(\/$)/, '') %>
<% end -%>

%define debug_package %{nil}
%define __strip /bin/true

Group: System Environment/Daemons
Vendor: Treasure Data, Inc.
License: APL2
<% if !url.nil? and !url.empty? -%>
URL: <%= url %>
<%else -%>
URL: http://nourlgiven.example.com/
<% end -%>
Packager: <%= maintainer %>

<% if !attributes[:no_depends?] -%>
<% dependencies.each do |req| -%>
Requires: <%= req %>
<% end -%>
<% end -%>
<% provides.each do |prov| -%>
Provides: <%= prov %>
<% end -%>
<% conflicts.each do |conflict| -%>
Conflicts: <%= conflict %>
<% end -%>
<% replaces.each do |repl| -%>
<%# The closes equivalent in RPM to "replaces" is "Obsoletes" -%>
Obsoletes: <%= repl %>
<% end -%>
<%# rpm rejects descriptions with blank lines (even between content), so hack
    around it by replacing blank lines with ' .' -%>
%description
<%= description.gsub(/^\s*$/, " .") %>

%prep
# noop

%build
# noop

%install
rm -rf $RPM_BUILD_ROOT
mkdir -p %buildroot/usr/%{_lib}
cp -rf /usr/%{_lib}/fluent %buildroot/usr/%{_lib}
rm -rf %buildroot/usr/%{_lib}/fluent/bin
mv %buildroot/usr/%{_lib}/fluent/usr/{bin,sbin} %buildroot/usr
mv %buildroot/usr/%{_lib}/fluent/etc %buildroot
mkdir -p %buildroot/var/log/%{name}

%clean
rm -rf %buildroot
rm -rf $RPM_BUILD_ROOT

<%# This next section puts any %pre, %post, %preun, or %postun scripts %>
<% 
  scriptmap = {
    :before_install => "pre",
    :after_install => "post",
    :before_remove => "preun",
    :after_remove => "postun",
  }
  scriptmap.each do |name, rpmname| 
-%>
<%   if script?(name) -%>
%<%= rpmname %>
<%= script(name) %>

<%   end -%>
<% end -%>

%files
%defattr(-,root,root)
%config(noreplace,missingok) %{_sysconfdir}/td-agent/td-agent.conf
/usr/bin/td
/usr/sbin/td-agent
/usr/%{_lib}/fluent
/etc/td-agent/td-agent.conf.tmpl
/etc/init.d/td-agent
/etc/td-agent/logrotate.d/td-agent.logrotate
/etc/td-agent/prelink.conf.d/td-agent.conf
/var/log/td-agent


%changelog
<%= attributes[:rpm_changelog] %>
